<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Features • opentripplanner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Features">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">opentripplanner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/advanced_features.html">Advanced Features</a>
    </li>
    <li>
      <a href="../articles/dummies_guide.html">Dummies Guide</a>
    </li>
    <li>
      <a href="../articles/getting_started.html">opentripplanner: getting started</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Advanced Features</h1>
                        <h4 class="author">Marcus Young, modified by Malcolm Morganr</h4>
            
            <h4 class="date">2019-02-20</h4>
      
      
      <div class="hidden name"><code>advanced_features.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The vignette introduces some of the more advanced features of OTP, and gives some examples of the types of anlaysis that are possible when using OTP and R togther.</p>
<div id="recap" class="section level3">
<h3 class="hasAnchor">
<a href="#recap" class="anchor"></a>Recap</h3>
<p>For this vingnette we will use the same data as the <code>getting_started</code> vingette. If you have not yet created the example graph you can set it up with the following commands. If you are using non-default settings see the <code>getting_started</code> vingette for full details.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(opentripplanner)
<span class="co"># Path to a folder containing the OTP.jar file, change to where you saved the file.</span>
path_otp &lt;-<span class="st"> "C:/Users/Public/otp.jar"</span>
path_data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/getwd">getwd</a></span>() <span class="co"># find the current working directory</span>
log &lt;-<span class="st"> </span><span class="kw"><a href="../reference/otp_build_graph.html">otp_build_graph</a></span>(<span class="dt">otp =</span> path_otp, <span class="dt">dir =</span> path_data)
<span class="kw"><a href="../reference/otp_setup.html">otp_setup</a></span>(<span class="dt">otp =</span> path_otp, <span class="dt">dir =</span> path_data, <span class="dt">analyst =</span> T)
otpcon &lt;-<span class="st"> </span><span class="kw"><a href="../reference/otp_connect.html">otp_connect</a></span>()</code></pre></div>
</div>
</div>
<div id="isochrones" class="section level2">
<h2 class="hasAnchor">
<a href="#isochrones" class="anchor"></a>Isochrones</h2>
<p>Now that we have a working instance of OTP, we’ll use it to generate some travel-time isochrones. We are interested in visualising how long it takes to access Ryde ferry using public transport from different parts of the island. We will do this by requesting isochrones from OTP for 15, 30, 45, 60, 75 and 90 minutes. This can be achieved with a single function <code><a href="../reference/otp_isochrone.html">otp_isochrone()</a></code>.</p>
<p>Isochrones requires the analyst extension to OTP.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ferry_current  &lt;-<span class="st"> </span><span class="kw"><a href="../reference/otp_isochrone.html">otp_isochrone</a></span>(<span class="dt">otpcon =</span> otpcon,
            <span class="dt">fromPlace =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">50.732429</span>, <span class="op">-</span><span class="fl">1.159494</span>), <span class="co"># latlong of Ryde ferry</span>
            <span class="dt">mode =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"WALK"</span>,<span class="st">"TRANSIT"</span>),
            <span class="dt">maxWalkDistance =</span> <span class="dv">2000</span>,
            <span class="dt">date_time =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.POSIXlt">as.POSIXct</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/strptime">strptime</a></span>(<span class="st">"2018-06-03 13:30"</span>, <span class="st">"%Y-%m-%d %H:%M"</span>)),
            <span class="dt">cutoffSec =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">15</span>, <span class="dv">30</span>, <span class="dv">45</span>, <span class="dv">60</span>, <span class="dv">75</span>, <span class="dv">90</span>) <span class="op">*</span><span class="st"> </span><span class="dv">60</span> ) <span class="co"># Cut offs in seconds</span>
ferry_current<span class="op">$</span>minutes =<span class="st"> </span>ferry_current<span class="op">$</span>time <span class="op">/</span><span class="st"> </span><span class="dv">60</span> <span class="co"># Convert back to minutes</span></code></pre></div>
<p>We can visualise the isochrones on a map using the <code>tmap</code> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tmap)                       <span class="co"># Load the tmap package</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/tmap/topics/tmap_mode">tmap_mode</a></span>(<span class="st">"view"</span>)                   <span class="co"># Set tmap to interative viewing</span>
map &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/tmap/topics/tm_shape">tm_shape</a></span>(ferry_current) <span class="op">+</span><span class="st">  </span><span class="co"># Build the map</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/tmap/topics/tm_polygons">tm_fill</a></span>(<span class="st">"minutes"</span>,
          <span class="dt">breaks =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="fl">15.001</span>, <span class="fl">30.001</span>, <span class="fl">45.001</span>, <span class="fl">60.001</span>, <span class="fl">75.001</span>, <span class="fl">90.001</span>),
          <span class="dt">style =</span> <span class="st">"fixed"</span>,
          <span class="dt">palette =</span> <span class="st">"-RdYlBu"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/tmap/topics/tm_polygons">tm_borders</a></span>()
map                                 <span class="co"># Plot the map</span></code></pre></div>
<p>You should see a map like this.</p>
<div class="figure" style="text-align: center">
<img src="images/isochrone.jpg" alt="\label{fig:otpgui}Isochrones from Manchester Airport" width="250"><p class="caption">
Isochrones from Manchester Airport
</p>
</div>
</div>
<div id="batch-routing" class="section level2">
<h2 class="hasAnchor">
<a href="#batch-routing" class="anchor"></a>Batch Routing</h2>
<p>In this final part of the tutorial, we are going to automate querying the OTP API to generate large quantities of route data - potentially for many thousands of origin:destination pairs. In this example, we will gather data on travel times between each of the LSOAs in on the Isle of White and the Rye Ferry.</p>
<p>To do this we will be using the <code>otp_route_batch</code> function.</p>
<p>We’ll start by importing the sample data</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/download.file">download.file</a></span>(<span class="st">"https://github.com/ITSLeeds/opentripplanner/releases/download/0.1/centroids.gpkg"</span>, 
              <span class="dt">destfile =</span> <span class="st">"centroids.gpkg"</span>, <span class="dt">mode=</span><span class="st">"wb"</span>)
lsoa &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="st">"centroids.gpkg"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(lsoa)</code></pre></div>
<p><code>otp_plan_batch</code> requires the fromPlace and the toPlace to each be either 2 x m matricies where each row is a latitute/longditude pair, or a SF data.frame of only POINTS. The number of rows in fromPlace and toPlace must be the same. So we will repete the coordinates for the Rye Ferry for each LSOA point.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">toPlace &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">50.732429</span>, <span class="op">-</span><span class="fl">1.159494</span>),<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(lsoa)), <span class="dt">ncol =</span> <span class="dv">2</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(toPlace)</code></pre></div>
<p>Now we can use the <code>otp_plan_batch</code> to find the routes</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">routes &lt;-<span class="st"> </span><span class="kw"><a href="../reference/otp_plan_batch.html">otp_plan_batch</a></span>(<span class="dt">otpcon =</span> otpcon,
                         <span class="dt">fromPlace =</span> lsoa,
                         <span class="dt">toPlace =</span> toPlace)</code></pre></div>
<p>You may get some error message returned as OTP is unable to find some of the routes. The <code>otp_plan_batch</code> will skip over errors and return all the routes it can get. It will then print out any error messages. You will have also noticed the handy progress bar.</p>
<p>You can plot the routes using <code>tmap</code></p>
<p>If you do plot all the routes it should look something like this:</p>
<div class="figure" style="text-align: center">
<img src="images/routes_to_ferry.jpg" alt="\label{fig:route2airport}Driving Routes to Rye Ferry" width="312"><p class="caption">
Driving Routes to Rye Ferry
</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#isochrones">Isochrones</a></li>
      <li><a href="#batch-routing">Batch Routing</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Marcus Young, Malcolm Morgan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
